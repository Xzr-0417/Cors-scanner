# CORS Payload Templates

Набор шаблонов payload’ов и алгоритм анализа ответов для автоматизированного поиска CORS‑уязвимостей.

---

## 1. Шаблоны payload’ов

### 1.1. Поля подстановки

- `{hostname}` — исходный hostname из целевого URL  
- `{hostname_upper}` — тот же hostname, приведённый к ВЕРХНЕМУ регистру  
- `{hostname_dash}` — hostname с заменой точек на дефисы  
- `{scheme_down}` — пониженная схема (например, `https` → `http`)  
- `{ip}` — IP‑адрес, если hostname уже является IP  

---

### 1.2. Таблица payload’ов

#### A. Обязательная группа (1–3)

| ID | Группа                 | Тип                     | Шаблон                             | Описание                                                        |
|----|------------------------|-------------------------|------------------------------------|-----------------------------------------------------------------|
| 1  | A обязательная группа  | фиксированная константа | `https://evil.com`                 | Фиксированная константа – отражение/подстановка                |
| 2  | A обязательная группа  | фиксированная константа | `null`                             | Фиксированная константа – доверие к `null`                     |
| 3  | A обязательная группа  | операция протокола      | `{scheme_down}://{hostname}`       | Понижение протокола – путаница протоколов                      |

#### B. Базовая группа (4–8)

| ID | Группа                 | Тип                      | Шаблон                             | Описание                                                                 |
|----|------------------------|--------------------------|------------------------------------|--------------------------------------------------------------------------|
| 4  | B базовая группа       | операция подстроки       | `https://evil-{hostname}`          | Префикс‑подстрока – неподдержанный якорь в подстроке/регексе            |
| 5  | B базовая группа       | операция eTLD            | `https://{hostname}.evil.com`      | Суффикс с eTLD – обход по eTLD                                          |
| 6  | B базовая группа       | операция поддомена       | `https://evil.{hostname}`          | Поддомен – маска поддоменов `*.{domain}`                                |
| 7  | B базовая группа       | операция порта           | `https://{hostname}:9443`          | Смена порта – отсутствие белого списка портов                           |
| 8  | B базовая группа       | операция порта           | `https://{hostname}:443`           | Явный порт по умолчанию – расхождение стандартизации URL/белого списка |

#### C. Углублённая группа (9–14)

| ID | Группа                 | Тип                         | Шаблон                             | Описание                                                                 |
|----|------------------------|-----------------------------|------------------------------------|--------------------------------------------------------------------------|
| 9  | C углублённая группа   | операция IP                 | `https://{ip}`                     | Голый IP – доверие к внутренней сети                                     |
| 10 | C углублённая группа   | фиксированная константа     | `https://localhost`                | Фиксированная константа – остатки dev‑окружения                         |
| 11 | C углублённая группа   | операция регистра           | `https://{hostname_upper}`         | Hostname в ВЕРХНЕМ РЕГИСТРЕ – несогласованность регистра                 |
| 12 | C углублённая группа   | операция URL‑кодирования    | `https://evil%2E{hostname}`        | Закодированная точка – баг порядка нормализации                          |
| 13 | C углублённая группа   | операция замены символов    | `http://{hostname_dash}.evil.com`  | Дефис вместо точки – пропуск в regexp                                    |
| 14 | C углублённая группа   | нормализация домена         | `https://{hostname}.`              | Домен с точкой на конце – расхождение Host‑нормализации/белого списка/кэша |

---

### 1.3. Логика групп

- **A обязательная группа (ID 1–3: evil / null / понижение протокола)**  
  - Если срабатывает любой payload из группы A → классифицируем как **High** и продолжаем тестирование.  
  - Если не срабатывает ни один → останавливаемся по данному URL.  
  - Цель: гарантировать, что кейсы «отражение/null/подстановка + креды» полностью выявлены.

- **B базовая группа (ID 4–8: подстрока / eTLD / поддомен / порт)**  
  - При срабатывании с уровнем **High** продолжаем.  
  - При **Medium** можно остановиться.  
  - Цель: покрыть порядка 80 % дефектов реализации белого списка.

- **C углублённая группа (ID 9–14: IP / localhost / регистр / кодирование / дефис и т.п.)**  
  - Любое срабатывание на любом уровне → **стоп** для данного URL.  
  - Цель: защита от чрезмерного расхода трафика и времени проверки.

---

## 2. Алгоритм анализа заголовков CORS

Шаг 1 — Есть ли ACAO?  
├─ В ответе вообще нет заголовка ACAO → 10. нет ACAO → Шаг 4 (проверка Vary) → завершить текущий набор запросов и перейти к следующему циклу отправки payload’ов  
└─ ACAO есть → перейти к Шагу 2  

Шаг 2 — Сколько значений у ACAO?  
├─ В заголовках ACAO встречается два и более раза (через запятую или дублирующиеся строки) → 9. несколько ACAO → уязвимость Low  
└─ Только одно значение → переходим к Шагу 3  

Шаг 3 — Какое единственное значение ACAO?  
│  
├─ "*"  
│   ├─ ACAC отсутствует или равен false → 1. * + нет ACAC → уязвимость Low  
│   └─ ACAC = true → 2. * + ACAC:true → уязвимость High  
│  
├─ "null"  
│   ├─ ACAC отсутствует или равен false → 3. null + нет ACAC → повторно отправить запрос с origin:null →  
│   │                                                                                         ├─ ACAO: * + нет ACAC → уязвимость High  
│   │                                                                                         ├─ ACAO: null + нет ACAC → Low  
│   │                                                                                         ├─ ACAO: null + ACAC:true → уязвимость High  
│   │                                                                                         └─ ACAO больше не возвращается  
│   └─ ACAC = true → 4. null + ACAC:true → уязвимость High  
│  
├─ Строго буквальное совпадение с Origin из запроса (истинное отражение)  
│   │  
│   └─ Проверяем ACAC  
│       │  
│       ├─ ACAC отсутствует или false → уязвимость Medium (Reflected Origin without Creds)  
│       │  
│       └─ ACAC = true  
│             │  
│             ├─ Оцениваем по текущему ID payload’а:  
│             │   │  
│             │   ├─ ID 1 (evil.com) → вывод: отражение любого источника (High)  
│             │   │     └─ ：остановить все дальнейшие CORS‑тесты для этого URL и зафиксировать максимально критичную уязвимость.  
│             │   │  
│             │   ├─ ID 3 (http://...) → вывод: путаница/понижение протокола (High)  
│             │   │  
│             │   ├─ ID 4 (evil-org) → вывод: префикс/отсутствие якоря в regexp (High)  
│             │   │  
│             │   ├─ ID 5 (org.evil) → вывод: обход по eTLD/суффиксу (High)  
│             │   │  
│             │   ├─ ID 6 (evil.org) → вывод: риск маски поддоменов/захвата поддомена (High)  
│             │   │  
│             │   ├─ ID 11 (UPPERCASE) → вывод: некорректная обработка регистра (High)  
│             │   │     └─ (Примечание: проверяем только при отправке ID 11, отдельно для ID 1 это не нужно.)  
│             │   │  
│             │   └─ ID 13/14 и др. → вывод: соответствующий дефект regexp (High)  
│             │  
│             └─ Если все payload’ы были отправлены и совпадений нет → завершить  
│  
└─ Значение ACAO ни "*", ни "null" и не совпадает с текущим Origin  
      ├─ ACAC отсутствует или false → 7. фиксированный белый список ≠ Origin + нет ACAC → уязвимость Low  
      └─ ACAC = true  
                                │  
                                ├─ Это внутренний домен/IP (например, localhost, 192.168.x)?  
                                │          ├─ классифицировать как Low  
                                │          └─ «раскрывает внутренний доверенный домен dev‑окружения»  
                                │  
                                ├─ Это внешний домен (например, partner.com)?  
                                │           ├─ классифицировать как Medium  
                                │           └─ «если на partner.com есть XSS, можно скомпрометировать этот интерфейс»  
                                │  
                                └─ Отличается только протоколом/портом (например, http vs https)?  
                                              └─ игнорируем (нормальная безопасная политика)  

Шаг 4  
├─ ① X-Forwarded-Host  
├─ ② Предварительный OPTIONS‑запрос + ACAM/ACAH + preflight без Origin  
└─ ③ Vary  

