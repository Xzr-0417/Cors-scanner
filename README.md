# CORS Payload Templates

Набор шаблонов payload’ов и алгоритм анализа ответов для автоматизированного поиска CORS‑уязвимостей.

---

## 1. Шаблоны payload’ов

### 1.1. Поля подстановки

- `{hostname}` — исходный hostname из целевого URL  
- `{hostname_upper}` — тот же hostname, приведённый к ВЕРХНЕМУ регистру  
- `{hostname_dash}` — hostname с заменой точек на дефисы  
- `{scheme_down}` — пониженная схема (например, `https` → `http`)  
- `{ip}` — IP‑адрес, если hostname уже является IP  

---

### 1.2. Таблица payload’ов

#### A. Обязательная группа (1–3)

| ID | Группа                 | Тип                     | Шаблон                             | Описание                                                        |
|----|------------------------|-------------------------|------------------------------------|-----------------------------------------------------------------|
| 1  | A обязательная группа  | фиксированная константа | `https://evil.com`                 | Фиксированная константа – отражение/подстановка                |
| 2  | A обязательная группа  | фиксированная константа | `null`                             | Фиксированная константа – доверие к `null`                     |
| 3  | A обязательная группа  | операция протокола      | `{scheme_down}://{hostname}`       | Понижение протокола – путаница протоколов                      |

#### B. Базовая группа (4–8)

| ID | Группа                 | Тип                      | Шаблон                             | Описание                                                                 |
|----|------------------------|--------------------------|------------------------------------|--------------------------------------------------------------------------|
| 4  | B базовая группа       | операция подстроки       | `https://evil-{hostname}`          | Префикс‑подстрока – неподдержанный якорь в подстроке/регексе            |
| 5  | B базовая группа       | операция eTLD            | `https://{hostname}.evil.com`      | Суффикс с eTLD – обход по eTLD                                          |
| 6  | B базовая группа       | операция поддомена       | `https://evil.{hostname}`          | Поддомен – маска поддоменов `*.{domain}`                                |
| 7  | B базовая группа       | операция порта           | `https://{hostname}:9443`          | Смена порта – отсутствие белого списка портов                           |
| 8  | B базовая группа       | операция порта           | `https://{hostname}:443`           | Явный порт по умолчанию – расхождение стандартизации URL/белого списка |

#### C. Углублённая группа (9–14)

| ID | Группа                 | Тип                         | Шаблон                             | Описание                                                                 |
|----|------------------------|-----------------------------|------------------------------------|--------------------------------------------------------------------------|
| 9  | C углублённая группа   | операция IP                 | `https://{ip}`                     | Голый IP – доверие к внутренней сети                                     |
| 10 | C углублённая группа   | фиксированная константа     | `https://localhost`                | Фиксированная константа – остатки dev‑окружения                         |
| 11 | C углублённая группа   | операция регистра           | `https://{hostname_upper}`         | Hostname в ВЕРХНЕМ РЕГИСТРЕ – несогласованность регистра                 |
| 12 | C углублённая группа   | операция URL‑кодирования    | `https://evil%2E{hostname}`        | Закодированная точка – баг порядка нормализации                          |
| 13 | C углублённая группа   | операция замены символов    | `http://{hostname_dash}.evil.com`  | Дефис вместо точки – пропуск в regexp                                    |
| 14 | C углублённая группа   | нормализация домена         | `https://{hostname}.`              | Домен с точкой на конце – расхождение Host‑нормализации/белого списка/кэша |

---

### 1.3. Логика групп

- **A обязательная группа (ID 1–3: evil / null / понижение протокола)**  
  - Если срабатывает любой payload из группы A → классифицируем как **High** и продолжаем тестирование.  
  - Если не срабатывает ни один → останавливаемся по данному URL.  
  - Цель: гарантировать, что кейсы «отражение/null/подстановка + креды» полностью выявлены.

- **B базовая группа (ID 4–8: подстрока / eTLD / поддомен / порт)**  
  - При срабатывании с уровнем **High** продолжаем.  
  - При **Medium** можно остановиться.  
  - Цель: покрыть порядка 80 % дефектов реализации белого списка.

- **C углублённая группа (ID 9–14: IP / localhost / регистр / кодирование / дефис и т.п.)**  
  - Любое срабатывание на любом уровне → **стоп** для данного URL.  
  - Цель: защита от чрезмерного расхода трафика и времени проверки.

---

## 2. Алгоритм анализа заголовков CORS

### Шаг 1 — Есть ли заголовок `Access-Control-Allow-Origin` (ACAO)?

- В ответе **нет** заголовка `ACAO`  
  → кейс **«10. нет ACAO»**  
  → перейти к **Шагу 4 (проверка Vary и доп. заголовков)**  
  → завершить текущий набор запросов и перейти к следующему циклу отправки payload’ов для этого URL.

- В ответе `ACAO` **есть**  
  → перейти к **Шагу 2**.

---

### Шаг 2 — Сколько значений у ACAO?

- В заголовках `ACAO` встречается **два и более раза**  
  - либо через запятую в одном заголовке,  
  - либо как дублирующиеся строки.  
  → кейс **«9. несколько ACAO»**  
  → классифицировать как уязвимость **Low**.

- Только **одно значение** `ACAO`  
  → перейти к **Шагу 3**.

---

### Шаг 3 — Анализ единственного значения ACAO

Рассматриваем возможные варианты значения `ACAO`.

#### 3.1. Значение `"*"`

- `ACAC` (Access-Control-Allow-Credentials) **отсутствует** или равно `false`  
  → кейс **«1. * + нет ACAC»**  
  → уязвимость **Low**.

- `ACAC = true`  
  → кейс **«2. * + ACAC:true»**  
  → уязвимость **High**.

---

#### 3.2. Значение `"null"`

- `ACAC` **отсутствует** или `false`  
  → кейс **«3. null + нет ACAC»**  
  → повторно отправляем запрос с заголовком `Origin: null` и проверяем новый ответ:

  - `ACAO: *` и `ACAC` отсутствует  
    → уязвимость **High**.  
  - `ACAO: null` и `ACAC` отсутствует  
    → уязвимость **Low**.  
  - `ACAO: null` и `ACAC:true`  
    → уязвимость **High**.  
  - `ACAO` больше не возвращается  
    → считаем, что защита сработала, уязвимость не подтверждается.

- `ACAC = true`  
  → кейс **«4. null + ACAC:true»**  
  → уязвимость **High**.

---

#### 3.3. Строгое буквальное совпадение с Origin (истинное отражение)

Если значение `ACAO` **строго совпадает** с `Origin`, присланным в запросе:

1. Проверяем `ACAC`:
   - `ACAC` **отсутствует** или `false`  
     → уязвимость **Medium** (*Reflected Origin without Creds*).

   - `ACAC = true`  
     → оцениваем по **ID текущего payload’а** (значению `Origin`, с которым мы отправляли запрос):

2. Классификация по ID payload’а при `ACAC = true`:

   - **ID 1** (`https://evil.com`)  
     → вывод: «отражение любого источника»  
     → уязвимость **High**  
     → остановить все дальнейшие CORS‑тесты для этого URL и зафиксировать максимально критичную уязвимость.

   - **ID 3** (`{scheme_down}://{hostname}`)  
     → вывод: «путаница/понижение протокола»  
     → уязвимость **High**.

   - **ID 4** (`https://evil-{hostname}`)  
     → вывод: «префикс/отсутствие якоря в regexp»  
     → уязвимость **High**.

   - **ID 5** (`https://{hostname}.evil.com`)  
     → вывод: «обход по eTLD/суффиксу»  
     → уязвимость **High**.

   - **ID 6** (`https://evil.{hostname}`)  
     → вывод: «риск маски поддоменов/захвата поддомена»  
     → уязвимость **High**.

   - **ID 11** (`https://{hostname_upper}`)  
     → вывод: «некорректная обработка регистра»  
     → уязвимость **High**.  
     - Примечание: проверяется только при отправке payload’а с ID 11. Для ID 1 отдельно не требуется.

   - **ID 13/14 и другие спец‑payload’ы**  
     → вывод: уязвимость, соответствующая конкретному дефекту regexp/нормализации (например, дефис вместо точки, точка в конце домена и т.д.)  
     → уязвимость **High**.

3. Если **все payload’ы были отправлены**, а отражения с `ACAC:true` ни для одного из них нет  
   → тестирование CORS для этого URL завершено, критичных уязвимостей отражения не найдено.

---

#### 3.4. Значение ACAO не `"*"`, не `"null"` и не совпадает с текущим Origin

- `ACAC` **отсутствует** или `false`  
  → кейс **«7. фиксированный белый список ≠ Origin + нет ACAC»**  
  → уязвимость **Low** (косвенно указывает на статический белый список без кредов).

- `ACAC = true`  
  → считаем, что сервер **доверяет какому-то другому домену**, отличному от нашего Origin:

  1. Если это **внутренний домен/IP**  
     - Примеры: `localhost`, `127.0.0.1`, `192.168.x.x`, `10.x.x.x` и другие внутренние диапазоны.  
     → классифицировать как уязвимость **Low**  
     → формулировка: «раскрывает внутренний доверенный домен dev‑окружения».

  2. Если это **внешний домен**  
     - Примеры: `https://partner.com`, `https://sso.partner.org` и т.п.  
     → классифицировать как уязвимость **Medium**  
     → формулировка: «если на `partner.com` есть XSS, можно скомпрометировать этот интерфейс».

  3. Если `ACAO` **отличается только протоколом или портом**  
     - Например: `http://example.com` вместо `https://example.com`,  
       или `https://example.com:443` vs `https://example.com`.  
     → это считается **нормальной, безопасной политикой**  
     → такие различия игнорируем.

---

### Шаг 4 — Дополнительные проверки

Дополнительные техники для углублённого анализа конфигурации CORS и прокси:

1. **`X-Forwarded-Host`**
   - Проверить влияние пользовательского значения `X-Forwarded-Host` на:
     - генерируемые ссылки,
     - формирование CORS‑заголовков,
     - логику определения доверенных Origin.

2. **Предварительный `OPTIONS`‑запрос (preflight)**
   - Отправить preflight‑запрос:
     - с заголовками `Access-Control-Request-Method` (ACAM) и `Access-Control-Request-Headers` (ACAH),
     - **без** заголовка `Origin`.  
   - Оценить:
     - как сервер обрабатывает preflight без Origin,
     - не выдаёт ли он чрезмерно широкие значения `ACAO`, `ACAC`, `ACAM`, `ACAH`.

3. **`Vary`**
   - Проверить наличие и содержание заголовка `Vary`:
     - `Vary: Origin` обязателен для корректного кэширования ответов с динамическим ACAO,
     - отсутствие `Vary: Origin` при отражающемся ACAO может приводить к:
       - утечкам межпользовательских данных,
       - некорректному кэш‑sharing между разными Origin.

---

{Покажи пример полноценного отчёта об уязвимости CORS на основе этого алгоритма.}  
{Распиши, как можно автоматизировать этот алгоритм тестирования CORS в виде скрипта или утилиты.}
